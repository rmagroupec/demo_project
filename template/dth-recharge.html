{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="main-content">

    <div class="page-content">
        <div class="container-fluid">
           
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header" style="background-color: #405189;">
                            <h5 class="card-title mb-0 text-white">Dth Recharge
                            </h5>
                        </div>
                        <div class="card-body">
                            <form >
                                {% csrf_token %}
                            <div class="row">
                                <div class="col-6 col-md-6">
                                    <div class="d-flex mt-4">
                                       
                                        <div class="flex-grow-1 overflow-hidden">
                                            <div class="mb-3">
                                                <label for="lastNameinput" class="form-label">DTH Operator
                                                </label>
                                                <select class="form-select sl" id="operator" aria-label=".form-select-lg example"
                                                style="width: 100%;">
                                                {% for recharge in rdata  %}
                                                    <option value="{{recharge.name}}">{{recharge.name}}</option>
                                                    {% endfor %}
                                                
                                            </select>
                                            </div>
                                       </div>
                                    </div>
                                </div>
                                <!--end col-->
                                <div class="col-6 col-md-6">
                                    <div class="d-flex mt-4">
                                        <div class="flex-shrink-0 avatar-xs align-self-center me-3">
                                            
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <div class="mb-3">
                                                <label for="lastNameinput" class="form-label">Dth Number
                                                </label>
                                                <input type="number" id="number" class="form-control" placeholder="Enter your Dth Number
                                                " 
                                                style="border: none;border-bottom: 1px solid #405189;border-radius: 0px;"
                                                >
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </div>
                            
                              <div class="row">
                                <div class="col-6 col-md-6">
                                    <div class="d-flex mt-4">
                                       
                                        <div class="flex-grow-1 overflow-hidden">
                                            <div class="mb-3">
                                                <label for="lastNameinput" class="form-label">Recharge Amount
                                                </label>
                                                <input type="number" class="form-control" placeholder="Enter your Recharge Amount
                                                " id="amount"
                                                style="border: none;border-bottom: 1px solid #405189;border-radius: 0px;"
                                                >

                                            </div>
                                            
                                       </div>

                                    </div>
                                    <span class="badge badge-soft-danger fs-13" style="cursor: pointer;background-color: #405189;color: white;"> Plan</span>
                                </div>
                                
                                <!--end col-->
                                <div class="col-6 col-md-6">
                                    <div class="d-flex mt-4">
                                        <div class="flex-shrink-0 avatar-xs align-self-center me-3">
                                            
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <div class="mb-3">
                                                <label for="lastNameinput" class="form-label">T-Pin
                                                </label>
                                                <input type="number" class="form-control" placeholder="Enter your T-Pin
                                                " id="pin"
                                                style="border: none;border-bottom: 1px solid #405189;border-radius: 0px;"
                                                >
                                            </div>
                                        </div>
                                        
                                    </div>
                                     <a href="#" data-bs-toggle="modal" data-bs-target="#change_retailer_pin" style="float: right;font-size: 15px;">Generate Or Forgot Pin?</a>
                                </div>
                              </div>
                              <hr>
                              <button type="button" class="btn" id="recharge-now"
                              style="background-color: #405189;color: white;float: right;">PAY NOW</button>
</form>
                        </div>
                    </div>
                </div><!--end col-->
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header" style="background-color: #405189;">
                            <h5 class="card-title mb-0 text-white">Recent Dth Recharge


                            </h5>
                        </div>
                        <div class="card-body">
                            <table id="alternative-pagination"
                                class="table nowrap dt-responsive align-middle table-hover table-bordered"
                                style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Order Id </th>
                                        <th>Recharge Details </th>
                                        <!-- <th> Transaction Details </th> -->
                                        <th>Amount/Commission </th>
                                        <th>Status</th>

                                    </tr>
                                </thead>
                                <tbody id="reports-data">
                                   
                                </tbody>
                            </table>


                        </div>
                    </div>
                </div><!--end col-->
            </div>
            <!--end row-->




        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
    <div class="modal fade" id="change_retailer_pin" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form class="row g-3 needs-validation" novalidate method="post">
                    {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="myModalLabel">Reset Pin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
                </div>
                <div class="modal-body">
                    
                        <div class="col-md-12">
                            <label for="validationCustom01" class="form-label">New Pin</label>
                            <input type="text" class="form-control" id="new-pin"  required name="new_pin">
                            <div class="valid-feedback">
                                Looks good!
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label for="validationCustom02" class="form-label">Confirm Pin</label>
                            <input type="text" class="form-control" id="confirm_pin"  required name="confirm_pin">
                            <div class="valid-feedback">
                                Looks good!
                            </div>
                        </div>
                        
                        <div class="col-md-12">
                            <label for="validationCustom04" class="form-label">Enter OTP</label>
                            <input type="text" class="form-control" id="otp"  required name="otp">
                            <div class="valid-feedback">
                                Looks good!
                            </div>
                        </div>
                       
                       
                         
                    
                    </div>
                <div class="modal-footer">
                    <button  id="get-otp-reset-pin" class="btn btn-primary" type="button">Get OTP</button>
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="change-transection-pin" class="btn btn-primary ">Change Pin</button>
                </div>
            </form>
    
            </div><!-- /.modal-content -->
        </div>
    </div>

    <footer class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-6">
                    <script>document.write(new Date().getFullYear())</script> © Velzon.
                </div>
                <div class="col-sm-6">
                    <div class="text-sm-end d-none d-sm-block">
                        Design & Develop by Themesbrand
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>

<script>
    $("#recharge-now").click(function(){
        let operator = $("#operator").val();
        let phone = $("#number").val();
        let amount = $("#amount").val();
        let pin = $("#pin").val();
        let csr = $("input[name=csrfmiddlewaretoken").val();
        mydata= {operator:operator, number:phone, amount:amount, pin:pin, csrfmiddlewaretoken:csr}
        $.ajax({
            url:"{% url 'create_dth_recharge' %}",
            method:"POST",
            data:mydata,
            success:function(data){
                getReportsData();
                Swal.fire(data.message)

            }
        })
    });



$(document).ready(function(){
    getReportsData();
})

function getReportsData(){
    $('#reports-data').empty(); 
    $.ajax({
        url:"{% url 'report_dth_recharge' %}",
        method:"GET",
        success:function(data){
            console.log(data);
            let i =0;
            data.data.forEach(element => {
            
                $('#reports-data').append('<tr>' + '<td>' + element.txn_id + '</td>' +  '<td>' + element.number + '</td>' + '<td>' + element.amount + '</td>' + '<td>' + element.status + '</td>' + '</tr>');  
           i =i++;
            });
        }
    })
}

// reset pin

$("#get-otp-reset-pin").click(function(){
    $.ajax({
        url:"{% url 'get_otp' %}",
        method:"GET", 
        success:function(data){
            Swal.fire(data.message)
        }
    });
});

$("#change-transection-pin").click(function(){
    let otp_pin = $("#new-pin").val();
    let confirm_pin = $("#confirm-pin").val();
    let otp = $("#otp").val();
    let csr = $("input[name=csrfmiddlewaretoken").val();
    data = {otp_pin:otp_pin, otp:otp, csrfmiddlewaretoken:csr};
    $.ajax({
        url:"{% url 'change_transection_pin' %}",
        method:"POST",
        data:data,
        success:function(data){
            $("#new-pin").val().empty();
            $("#confirm-pin").val().empty();
            $("#otp").val().empty();
            if(data.mtype == "success"){
                Swal.fire(data.message);
            }
            else{
                Swal.fire(data.message);
            }
        }
    })
})

    
</script>

{% endblock %}